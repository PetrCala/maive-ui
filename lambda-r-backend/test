# Lambda R Backend Dockerfile
FROM public.ecr.aws/lambda/provided:al2

# Set R environment variables
ENV R_HOME=/usr/lib64/R
ENV PATH=$PATH:$R_HOME/bin

# Copy package installation scripts
COPY r-packages.txt /tmp/
COPY r-packages-extra.R /tmp/

# Install R packages from CRAN
RUN R -e "packages <- readLines('/tmp/r-packages.txt'); install.packages(packages, repos='https://cran.rstudio.com/')"

# Copy vendor folder for custom MAIVE package
COPY ../vendor/ /tmp/vendor/

# Install custom MAIVE package from vendor folder
RUN if [ -d "/tmp/vendor/maive" ]; then \
        echo "Installing MAIVE package from vendor folder"; \
        R CMD INSTALL /tmp/vendor/maive; \
    else \
        echo "Vendor folder not found, will install from GitHub"; \
    fi

# Install additional packages and MAIVE from GitHub if vendor not available
RUN R -e "source('/tmp/r-packages-extra.R')"

# Copy R scripts
COPY index.R ${LAMBDA_TASK_ROOT}
COPY maive_model.R ${LAMBDA_TASK_ROOT}
COPY funnel_plot.R ${LAMBDA_TASK_ROOT}

# Set the handler
CMD ["index.handler"]